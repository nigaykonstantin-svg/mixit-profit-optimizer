// Role-based AI insights with Claude
import Anthropic from '@anthropic-ai/sdk';

let anthropicClient: Anthropic | null = null;

export function getAnthropicClient(): Anthropic {
    if (!anthropicClient) {
        const apiKey = process.env.ANTHROPIC_API_KEY;
        if (!apiKey) {
            throw new Error('ANTHROPIC_API_KEY not configured');
        }
        anthropicClient = new Anthropic({ apiKey });
    }
    return anthropicClient;
}

export function isAnthropicConfigured(): boolean {
    return !!process.env.ANTHROPIC_API_KEY;
}

export interface CategoryData {
    name: string;
    revenue: number;
    orders: number;
    avgCr: number;
    lowStock: number;
    needsPriceDown: number;
    criticalCount: number;
    warningCount: number;
    recommendationsCount: number;
}

export interface InsightRequest {
    categories: CategoryData[];
    totals: {
        revenue: number;
        orders: number;
        skuCount: number;
    };
}

export type InsightRole =
    | 'leader'          // –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å/–í–ª–∞–¥–µ–ª–µ—Ü
    | 'category_manager' // –ö–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
    | 'mp_manager'      // –ú–µ–Ω–µ–¥–∂–µ—Ä –ú–ü –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º
    | 'supply_chain'    // –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å Supply Chain
    | 'brand_owner'     // –ë—Ä–µ–Ω–¥-–º–µ–Ω–µ–¥–∂–µ—Ä (–º–∏–Ω–∏-–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å)
    | 'marketing';      // –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ (—Ç—Ä–∞—Ñ–∏–∫, AB —Ç–µ—Å—Ç—ã)

const ROLE_PROMPTS: Record<InsightRole, string> = {
    leader: `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –í–õ–ê–î–ï–õ–¨–¶–ê –±–∏–∑–Ω–µ—Å–∞ e-commerce MIXIT –Ω–∞ Wildberries.

–î–∞–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä:
1. üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ (–≤—ã—Ä—É—á–∫–∞, –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å, —Ç—Ä–µ–Ω–¥—ã)
2. ‚ö†Ô∏è –¢–û–ü-3 —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
3. üöÄ –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º ROI
4. üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
5. üéØ –ö–ª—é—á–µ–≤—ã–µ KPI –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ

–§–æ—Ä–º–∞—Ç: executive summary, –º–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏.`,

    category_manager: `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –ö–ê–¢–ï–ì–û–†–ò–ô–ù–û–ì–û –ú–ï–ù–ï–î–ñ–ï–†–ê MIXIT.

–ê–Ω–∞–ª–∏–∑ –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
1. üì¶ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ (–≥–ª—É–±–∏–Ω–∞, —à–∏—Ä–∏–Ω–∞)
2. üíµ –¶–µ–Ω–æ–≤–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ vs –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã
3. üîÑ –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∏ ABC-–∞–Ω–∞–ª–∏–∑
4. ‚ùå SKU-–∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ –≤—ã–≤–æ–¥
5. ‚úÖ SKU –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ª–∏–Ω–µ–π–∫–∏
6. üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–∞–º (–∫–∞–∫–∏–µ SKU –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)

–ü–æ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–π 3-4 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—ã.`,

    mp_manager: `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –ú–ï–ù–ï–î–ñ–ï–†–ê –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°–ê –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º —Ç–æ–≤–∞—Ä–æ–≤.

–ê–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
1. üì∏ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∫–∞–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —É–ª—É—á—à–∏—Ç—å)
2. üîç SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∑–∞–≥–æ–ª–æ–≤–∫–∏)
3. üìä –ö–æ–Ω–≤–µ—Ä—Å–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ (CTR ‚Üí CR –∞–Ω–∞–ª–∏–∑)
4. ‚≠ê –†–µ–π—Ç–∏–Ω–≥–∏ –∏ –æ—Ç–∑—ã–≤—ã (–≥–¥–µ –ø—Ä–æ–±–ª–µ–º—ã)
5. üè∑Ô∏è –¶–µ–Ω–æ–≤—ã–µ –º–µ—Ç–∫–∏ –∏ –∞–∫—Ü–∏–∏
6. üì± –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –∫–∞—Ä—Ç–æ—á–µ–∫

–î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: —Å–ø–∏—Å–æ–∫ TOP-5 –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç—Ä–µ–±—É—é—â–∏—Ö –≤–Ω–∏–º–∞–Ω–∏—è –∏ –ø–æ—á–µ–º—É.`,

    supply_chain: `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –†–£–ö–û–í–û–î–ò–¢–ï–õ–Ø SUPPLY CHAIN MIXIT.

–õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:
1. üö® –ö–†–ò–¢–ò–ß–ù–û: SKU —Å —Ä–∏—Å–∫–æ–º –æ–±–Ω—É–ª–µ–Ω–∏—è (—Å—Ç–æ–∫ <7 –¥–Ω–µ–π)
2. ‚ö° –°–†–û–ß–ù–û: SKU –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–∫—É–ø–∞
3. üì¶ –ó–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ: SKU —Å –∏–∑–±—ã—Ç–æ—á–Ω—ã–º —Å—Ç–æ–∫–æ–º (>90 –¥–Ω–µ–π)
4. üîÑ –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
5. üìä –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏
6. üè≠ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É/–∑–∞–∫—É–ø–∫–∞–º

–§–æ—Ä–º–∞—Ç: —á—ë—Ç–∫–∏–µ —Å–ø–∏—Å–∫–∏ —Å –∞—Ä—Ç–∏–∫—É–ª–∞–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞–º–∏. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏.`,

    brand_owner: `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –ë–†–ï–ù–î-–ú–ï–ù–ï–î–ñ–ï–†–ê (–º–∏–Ω–∏-–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è) MIXIT.

–î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞:
1. üíº P&L –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—ã—Ä—É—á–∫–∞, –º–∞—Ä–∂–∞, EBITDA proxy)
2. üìä Unit-—ç–∫–æ–Ω–æ–º–∏–∫–∞ —Ç–æ–ø–æ–≤—ã—Ö SKU
3. üéØ –¶–µ–ª–∏ –Ω–∞ –ø–µ—Ä–∏–æ–¥ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
4. üÜö –ë–µ–Ω—á–º–∞—Ä–∫ vs –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
5. üí° 3 –∏–¥–µ–∏ –¥–ª—è —Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏
6. ‚ö†Ô∏è –†–∏—Å–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

–ö–∞–∂–¥–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è = –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–Ω–∏-–±–∏–∑–Ω–µ—Å. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–∞–∫ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—é.`,

    marketing: `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –ú–ê–†–ö–ï–¢–ò–ù–ì–ê MIXIT.

–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–π:
1. üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (CTR, CR)
2. üí∞ DRR –ø–æ –∫–∞–Ω–∞–ª–∞–º (–ø–æ–∏—Å–∫, –º–µ–¥–∏–∞, –±–ª–æ–≥–µ—Ä—ã)
3. üß™ –ò–¥–µ–∏ –¥–ª—è A/B —Ç–µ—Å—Ç–æ–≤:
   - –¶–µ–Ω—ã (–∫–∞–∫–∏–µ SKU —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å)
   - –ö–∞—Ä—Ç–æ—á–∫–∏ (–∫–∞–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–µ–Ω—è—Ç—å)
   - –ü—Ä–æ–º–æ-–º–µ—Ö–∞–Ω–∏–∫–∏
4. üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∫–ª–∞–º–Ω–æ–º—É –±—é–¥–∂–µ—Ç—É
5. üìä –ö–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–µ–∫–ª–∞–º–µ
6. ‚õî –ì–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Ä–µ–∫–ª–∞–º—É

–î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ A/B —Ç–µ—Å—Ç–∞–º.`
};

function buildDataContext(data: InsightRequest): string {
    return `
–î–ê–ù–ù–´–ï –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú:
${data.categories.map(cat => `
üì¶ ${cat.name}:
- –í—ã—Ä—É—á–∫–∞: ${(cat.revenue / 1000000).toFixed(2)}M ‚ÇΩ
- –ó–∞–∫–∞–∑–æ–≤: ${cat.orders.toLocaleString()}
- –°—Ä–µ–¥–Ω–∏–π CR: ${(cat.avgCr * 100).toFixed(2)}%
- –ö—Ä–∏—Ç–∏—á–Ω–æ –º–∞–ª–æ —Å—Ç–æ–∫–∞: ${cat.lowStock} SKU
- –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è: ${cat.warningCount} SKU
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω–∞–º: ${cat.recommendationsCount} SKU
`).join('\n')}

–ò–¢–û–ì–û:
- –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: ${(data.totals.revenue / 1000000).toFixed(2)}M ‚ÇΩ
- –û–±—â–∏–µ –∑–∞–∫–∞–∑—ã: ${data.totals.orders.toLocaleString()}
- SKU –≤ –∞–Ω–∞–ª–∏–∑–µ: ${data.totals.skuCount}
`;
}

export async function generateInsightsForRole(
    data: InsightRequest,
    role: InsightRole,
    categoryFilter?: string
): Promise<string> {
    const client = getAnthropicClient();

    const rolePrompt = ROLE_PROMPTS[role];
    const dataContext = buildDataContext(data);

    const categoryNote = categoryFilter
        ? `\n\n–§–û–ö–£–°: –°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryFilter}".`
        : '';

    const systemMessage = `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è MIXIT (–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π –±—Ä–µ–Ω–¥ –Ω–∞ Wildberries).

–ò–°–¢–û–ß–ù–ò–ö–ò –î–ê–ù–ù–´–• (Supabase):
1. **wb_funnel** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏: –≤—ã—Ä—É—á–∫–∞, –∑–∞–∫–∞–∑—ã, CTR, CR, —Å—Ç–æ–∫–∏, —Ü–µ–Ω—ã. –≠—Ç–æ —Ç–≤–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
2. **sku_catalog** ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤: –∞—Ä—Ç–∏–∫—É–ª (sku), –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (name), –∫–∞—Ç–µ–≥–æ—Ä–∏—è (category). –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ SKU –≤ —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –î–∞–≤–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –∞—Ä—Ç–∏–∫—É–ª–∞–º–∏ SKU
2. –ï—Å–ª–∏ –∑–Ω–∞–µ—à—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ‚Äî —É–∫–∞–∑—ã–≤–∞–π –µ–≥–æ —Ä—è–¥–æ–º —Å SKU
3. –ò—Å–ø–æ–ª—å–∑—É–π markdown: –∑–∞–≥–æ–ª–æ–≤–∫–∏ ##, —Å–ø–∏—Å–∫–∏ -, —Ç–∞–±–ª–∏—Ü—ã
4. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ (—Å–µ–≥–æ–¥–Ω—è), üü° –í–∞–∂–Ω–æ (–Ω–µ–¥–µ–ª—è), üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (–º–µ—Å—è—Ü)
5. –ß–∏—Å–ª–∞: –≤—ã—Ä—É—á–∫–∞ –≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö (44.4M ‚ÇΩ), –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Å 1 –∑–Ω–∞–∫–æ–º
6. –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ = –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π SKU + —á—Ç–æ –¥–µ–ª–∞—Ç—å + –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–§–û–†–ú–ê–¢ –¢–ê–ë–õ–ò–¶:
| SKU | –ù–∞–∑–≤–∞–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ | –°—Ä–æ–∫ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-----|----------|----------|------|-----------|
| SKUA001 | –ö—Ä–µ–º –¥–ª—è –ª–∏—Ü–∞ | –°–Ω–∏–∑–∏—Ç—å —Ü–µ–Ω—É 5% | 3 –¥–Ω—è | +15% CR |`;

    const prompt = `${rolePrompt}
${dataContext}
${categoryNote}`;

    const response = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1200,
        system: systemMessage,
        messages: [
            { role: 'user', content: prompt }
        ],
    });

    const textContent = response.content.find(block => block.type === 'text');
    return textContent?.text || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å–∞–π—Ç—ã';
}

// Legacy function for backward compatibility
export async function generateCategoryInsights(data: InsightRequest): Promise<string> {
    return generateInsightsForRole(data, 'leader');
}

export async function generateSkuInsight(skuData: {
    sku: string;
    revenue: number;
    orders: number;
    ctr: number;
    cr_order: number;
    stock: number;
    price_action: string;
    reason_text: string;
    category: string;
}): Promise<string> {
    const client = getAnthropicClient();

    const prompt = `–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è e-commerce. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π SKU:

SKU: ${skuData.sku}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${skuData.category}
–í—ã—Ä—É—á–∫–∞: ${(skuData.revenue / 1000).toFixed(1)}K ‚ÇΩ
–ó–∞–∫–∞–∑–æ–≤: ${skuData.orders}
CTR: ${(skuData.ctr * 100).toFixed(2)}%
CR: ${(skuData.cr_order * 100).toFixed(2)}%
–°—Ç–æ–∫: ${skuData.stock} —à—Ç
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${skuData.price_action} ‚Äî ${skuData.reason_text}

–î–∞–π 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π. –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ.`;

    const response = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 200,
        messages: [
            { role: 'user', content: prompt }
        ],
    });

    const textContent = response.content.find(block => block.type === 'text');
    return textContent?.text || '–ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
}

export const INSIGHT_ROLES: { id: InsightRole; label: string; icon: string; description: string }[] = [
    { id: 'leader', label: '–í–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–∞', icon: 'üëî', description: '–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä' },
    { id: 'category_manager', label: '–ö–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', icon: 'üì¶', description: '–ê—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –∏ —Ü–µ–Ω—ã' },
    { id: 'mp_manager', label: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ú–ü', icon: 'üè™', description: '–ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤' },
    { id: 'supply_chain', label: 'Supply Chain', icon: 'üöö', description: '–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ —Å—Ç–æ–∫–∏' },
    { id: 'brand_owner', label: '–ë—Ä–µ–Ω–¥-–º–µ–Ω–µ–¥–∂–µ—Ä', icon: 'üé®', description: 'P&L –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' },
    { id: 'marketing', label: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥', icon: 'üìà', description: '–¢—Ä–∞—Ñ–∏–∫ –∏ A/B —Ç–µ—Å—Ç—ã' },
];
